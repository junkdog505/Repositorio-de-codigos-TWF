# ============================================
# TWF.CODE - Astro Static + Dynamic Fallback
# ============================================

# Enable mod_rewrite
RewriteEngine On

# Set the base directory (adjust if your site is in a subdirectory)
RewriteBase /

# --- Dynamic fallback for /codes/[slug] ---
# If someone visits /codes/some-slug/ and the static file doesn't exist,
# internally serve the dynamic fallback page instead of a 404.
# This allows new WordPress posts to be loaded client-side via React.

# Only apply to /codes/SOMETHING (not /codes/ itself, not /codes/index.html)
RewriteCond %{REQUEST_URI} ^/codes/([^/]+)/?$
# Exclude the dynamic page itself to avoid infinite loops
RewriteCond %{REQUEST_URI} !^/codes/dynamic
# Exclude requests for actual files (CSS, JS, images, etc.)
RewriteCond %{REQUEST_FILENAME} !-f
# Exclude requests for actual directories that have an index.html
RewriteCond %{REQUEST_FILENAME}/index.html !-f
# Serve the dynamic fallback page (internal rewrite, no redirect)
RewriteRule ^codes/([^/]+)/?$ /codes/dynamic/index.html [L]

# --- Standard Astro static site rules ---
# Serve pre-existing static files directly
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# If a directory is requested and has an index.html, serve it
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_FILENAME}/index.html -f
RewriteRule ^(.*)/$ $1/index.html [L]

# Trailing slash redirect for clean URLs
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_FILENAME}.html !-f
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}/index.html -f
RewriteRule ^(.*)$ $1/ [R=301,L]

# Custom 404
ErrorDocument 404 /404.html
