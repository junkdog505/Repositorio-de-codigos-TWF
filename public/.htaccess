# ============================================
# TWF.CODE - Astro Static + Dynamic Fallback
# ============================================

# Enable mod_rewrite
RewriteEngine On

# Set the base directory (adjust if your site is in a subdirectory)
RewriteBase /

# --- Dynamic fallback for /codes/[slug] ---
# Only apply to /codes/SOMETHING (not /codes/ itself, not /codes/index.html)
RewriteCond %{REQUEST_URI} ^/codes/([^/]+)/?$
RewriteCond %{REQUEST_URI} !^/codes/dynamic
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}/index.html !-f
RewriteRule ^codes/([^/]+)/?$ /codes/dynamic/index.html [L]

# --- Dynamic fallback for /category/[slug] ---
RewriteCond %{REQUEST_URI} ^/category/([^/]+)/?$
RewriteCond %{REQUEST_URI} !^/category/dynamic
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}/index.html !-f
RewriteRule ^category/([^/]+)/?$ /category/dynamic/index.html [L]

# --- Dynamic fallback for /tag/[slug] ---
RewriteCond %{REQUEST_URI} ^/tag/([^/]+)/?$
RewriteCond %{REQUEST_URI} !^/tag/dynamic
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}/index.html !-f
RewriteRule ^tag/([^/]+)/?$ /tag/dynamic/index.html [L]

# --- Dynamic fallback for /author/[id] ---
RewriteCond %{REQUEST_URI} ^/author/([^/]+)/?$
RewriteCond %{REQUEST_URI} !^/author/dynamic
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}/index.html !-f
RewriteRule ^author/([^/]+)/?$ /author/dynamic/index.html [L]

# --- Standard Astro static site rules ---
# Serve pre-existing static files directly
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# If a directory is requested and has an index.html, serve it
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_FILENAME}/index.html -f
RewriteRule ^(.*)/$ $1/index.html [L]

# Trailing slash redirect for clean URLs
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !/$
RewriteCond %{REQUEST_FILENAME}.html !-f
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}/index.html -f
RewriteRule ^(.*)$ $1/ [R=301,L]

# Custom 404
ErrorDocument 404 /404.html
